<section class="internal-users-page">
  <header class="internal-users-header">
    <div>
      <p class="internal-users-eyebrow">Gestión de usuarios</p>
      <h2 class="internal-users-title">Usuarios internos - {{ ownerLabel() }}</h2>
      <p class="internal-users-subtitle">
        Administra los accesos internos, roles y estado de cuenta.
      </p>
    </div>
    <button type="button" class="btn btn-primary" (click)="openCreate()">
      Agregar usuario
    </button>
  </header>

  <div class="internal-users-card">
    @if (loading()) {
      <app-loading-card message="Cargando usuarios internos..."></app-loading-card>
    } @else if (error()) {
      <app-empty-state
        title="No se pudieron cargar los usuarios"
        [description]="error()"
        icon="exclamation-triangle"
      ></app-empty-state>
    } @else if (users().length === 0) {
      <app-empty-state
        title="No hay usuarios internos"
        description="Cuando agregues usuarios internos aparecerán aquí."
        icon="users"
      ></app-empty-state>
    } @else {
      <div class="internal-users-table">
        <table>
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Email</th>
              <th>Rol</th>
              <th>Estado</th>
              <th>Registro</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (user of users(); track user.id) {
              <tr>
                <td>
                  <div class="user-cell">
                    <div class="user-avatar">
                      {{ (getUserDisplayName(user) || 'U').slice(0, 2) }}
                    </div>
                    <div>
                      <p class="user-name">{{ getUserDisplayName(user) }}</p>
                      <p class="user-username">{{ user.username }}</p>
                    </div>
                  </div>
                </td>
                <td>{{ user.email }}</td>
                <td>{{ user.role || 'Sin rol' }}</td>
                <td>
                  <span class="status-badge" [class.active]="user.is_active" [class.inactive]="!user.is_active">
                    {{ user.is_active ? 'Activo' : 'Inactivo' }}
                  </span>
                </td>
                <td>{{ user.created_at || '—' }}</td>
                <td class="text-right">
                  <div class="row-actions">
                    <button type="button" class="action-link" (click)="openEdit(user)">
                      Editar
                    </button>
                    <button type="button" class="action-link" (click)="toggleActive(user)">
                      {{ user.is_active ? 'Desactivar' : 'Activar' }}
                    </button>
                    <button type="button" class="action-link danger" (click)="remove(user)">
                      Eliminar
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
    }
  </div>
</section>

@if (modalOpen()) {
  <app-modal
    [title]="isEditMode() ? 'Editar usuario interno' : 'Nuevo usuario interno'"
    size="lg"
    (close)="closeModal()"
  >
    <form [formGroup]="userForm" (ngSubmit)="submit()" class="modal-form">
      @if (formError()) {
        <div class="form-error-message">
          <span>{{ formError() }}</span>
        </div>
      }

      <div class="form-section">
        <h3 class="section-title">Información básica</h3>

        <div class="form-grid">
          <div class="form-group">
            <label for="username">
              Usuario <span class="required">*</span>
            </label>
            <input
              type="text"
              id="username"
              formControlName="username"
              placeholder="usuario"
              [class.invalid]="userForm.get('username')?.invalid && userForm.get('username')?.touched"
            />
            @if (userForm.get('username')?.invalid && userForm.get('username')?.touched) {
              <span class="error-text">{{ getFieldError('username') }}</span>
            }
          </div>

          <div class="form-group">
            <label for="email">
              Email <span class="required">*</span>
            </label>
            <input
              type="email"
              id="email"
              formControlName="email"
              placeholder="correo@ejemplo.com"
              [class.invalid]="userForm.get('email')?.invalid && userForm.get('email')?.touched"
            />
            @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
              <span class="error-text">{{ getFieldError('email') }}</span>
            }
          </div>

          <div class="form-group">
            <label for="first_name">Nombre</label>
            <input type="text" id="first_name" formControlName="first_name" placeholder="Nombre" />
          </div>

          <div class="form-group">
            <label for="last_name">Apellido</label>
            <input type="text" id="last_name" formControlName="last_name" placeholder="Apellido" />
          </div>

          <div class="form-group">
            <label for="role">Rol</label>
            <input type="text" id="role" formControlName="role" placeholder="Ej: Operador" />
          </div>

          <div class="form-group">
            <label for="password">
              Contraseña
              @if (!isEditMode()) {
                <span class="required">*</span>
              } @else {
                <span class="optional">(opcional)</span>
              }
            </label>
            <input
              type="password"
              id="password"
              formControlName="password"
              [placeholder]="isEditMode() ? 'Dejar en blanco para no cambiar' : 'Ingrese la contraseña'"
              [class.invalid]="userForm.get('password')?.invalid && userForm.get('password')?.touched"
            />
            @if (userForm.get('password')?.invalid && userForm.get('password')?.touched) {
              <span class="error-text">{{ getFieldError('password') }}</span>
            }
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="formLoading()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid || formLoading()">
          @if (formLoading()) {
            <div class="btn-spinner"></div>
            Guardando...
          } @else {
            {{ isEditMode() ? 'Guardar cambios' : 'Crear usuario' }}
          }
        </button>
      </div>
    </form>
  </app-modal>
}
