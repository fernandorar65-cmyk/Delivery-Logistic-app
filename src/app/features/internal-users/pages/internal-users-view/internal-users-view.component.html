<section class="internal-users-page">
  <header class="internal-users-header header-card">
    <div>
      <p class="internal-users-eyebrow">Gestión de usuarios</p>
      <h2 class="internal-users-title">Usuarios internos - {{ ownerLabel() }}</h2>
      <p class="internal-users-subtitle">
        Administra los accesos internos del proveedor.
      </p>
    </div>
    <button type="button" class="btn btn-primary" (click)="openCreate()">
      Agregar usuario
    </button>
  </header>

  <div class="internal-users-card">
    @if (loading()) {
    <app-loading-card message="Cargando usuarios internos..."></app-loading-card>
    } @else if (error()) {
    <app-empty-state title="No se pudieron cargar los usuarios" [description]="error()"
      icon="exclamation-triangle"></app-empty-state>
    } @else if (users().length === 0) {
    <app-empty-state title="No hay usuarios internos" description="Cuando agregues usuarios internos aparecerán aquí."
      icon="users"></app-empty-state>
    } @else {
    <div class="internal-users-table-wrapper">
      <table class="internal-users-table">
        <thead>
          <tr>
            <th class="table-header">Nombre completo</th>
            <th class="table-header">Correo electrónico</th>
            <th class="table-header">Estado</th>
            <th class="table-header">Registro</th>
            <th class="table-header text-right">Acciones</th>
          </tr>
        </thead>
        <tbody>
          @for (user of users(); track user.id) {
          <tr class="table-row">
            <td class="table-cell">
              <div class="user-cell">
                <div class="user-avatar">
                  {{ (getUserDisplayName(user) || 'U').slice(0, 2) }}
                </div>
                <div class="user-meta">
                  <p class="user-name">{{ getUserDisplayName(user) }}</p>
                </div>
              </div>
            </td>
            <td class="table-cell">
              <span class="cell-muted">{{ getUserEmail(user) }}</span>
            </td>
            <td class="table-cell">
              <label class="status-toggle">
                <input type="checkbox" checked />
                <span class="toggle-track"></span>
                <span class="toggle-label">Activo</span>
              </label>
            </td>
            <td class="table-cell">
              <span class="cell-muted">{{ getUserCreatedAtDisplay(user) }}</span>
            </td>
            <td class="table-cell text-right">
              <div class="row-actions">
                <button
                  type="button"
                  class="action-icon"
                  title="Editar (próximamente)">
                  <app-hero-icon name="pencil" [size]="16"></app-hero-icon>
                </button>
                <button type="button" class="action-icon danger" (click)="remove(user)">
                  <app-hero-icon name="trash" [size]="16"></app-hero-icon>
                </button>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>
</section>

@if (modalOpen()) {
<app-modal title="Nuevo usuario interno" size="lg" (close)="closeModal()">
  <form [formGroup]="userForm" (ngSubmit)="submit()" class="modal-form">
    @if (formError()) {
    <div class="form-error-message">
      <span>{{ formError() }}</span>
    </div>
    }

    <div class="form-section">
      <h3 class="section-title">Información básica</h3>

      <div class="form-grid">
        <div class="form-group">
          <label for="email">
            Email <span class="required">*</span>
          </label>
          <input type="email" id="email" formControlName="email" placeholder="correo@ejemplo.com"
            [class.invalid]="userForm.get('email')?.invalid && userForm.get('email')?.touched" />
          @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
          <span class="error-text">{{ getFieldError('email') }}</span>
          }
        </div>

        <div class="form-group">
          <label for="first_name">Nombre</label>
          <input type="text" id="first_name" formControlName="first_name" placeholder="Nombre" />
        </div>

        <div class="form-group">
          <label for="last_name">Apellido</label>
          <input type="text" id="last_name" formControlName="last_name" placeholder="Apellido" />
        </div>

        <div class="form-group">
          <label for="password">
            Contraseña
            <span class="required">*</span>
          </label>
          <input type="password" id="password" formControlName="password" placeholder="Ingrese la contraseña"
            [class.invalid]="userForm.get('password')?.invalid && userForm.get('password')?.touched" />
          @if (userForm.get('password')?.invalid && userForm.get('password')?.touched) {
          <span class="error-text">{{ getFieldError('password') }}</span>
          }
        </div>
      </div>
    </div>

    <div class="modal-actions">
      <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="formLoading()">
        Cancelar
      </button>
        <button type="submit" class="btn btn-primary" [disabled]="userForm.invalid || formLoading()">
          @if (formLoading()) {
            <div class="btn-spinner"></div>
            Guardando...
          } @else {
            Guardar interno
          }
        </button>
    </div>
  </form>
</app-modal>
}