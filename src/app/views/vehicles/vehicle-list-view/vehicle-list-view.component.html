<div class="page-container">
  <!-- Breadcrumbs -->
  <div class="breadcrumb">
    <a routerLink="/dashboard" class="breadcrumb-link">
      <app-hero-icon name="squares-2x2" [size]="16"></app-hero-icon>
      <span>Inicio</span>
    </a>
    <span class="breadcrumb-separator">/</span>
    <a routerLink="/allies" class="breadcrumb-link">Aliados</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">Vehículos de {{ allyLabel }}</span>
  </div>

  <!-- Page Header -->
  <div class="page-header">
    <div class="page-title-section">
      <h1 class="page-title">{{ pageTitle }}</h1>
      <p class="page-subtitle">{{ pageSubtitle }}</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()" [disabled]="!allyId()">
      <app-hero-icon name="plus" [size]="18"></app-hero-icon>
      Registrar Vehículo
    </button>
  </div>

  <!-- Stats Summary -->
  <div class="stats-grid">
    @for (stat of stats(); track stat.label) {
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon" [class]="'stat-icon-' + stat.iconColor">
            <app-hero-icon [name]="stat.icon" [size]="24"></app-hero-icon>
          </div>
          @if (stat.trendValue) {
            <span class="stat-trend" [class]="'stat-trend-' + stat.trend">
              {{ stat.trendValue }}
            </span>
          }
        </div>
        <p class="stat-label">{{ stat.label }}</p>
        <p class="stat-value">{{ stat.value }}</p>
      </div>
    }
  </div>

  <!-- Filters & Search -->
  <div class="filters-card">
    <div class="filters-container">
      <div class="search-wrapper">
        <app-hero-icon name="magnifying-glass" [size]="20" class="search-icon"></app-hero-icon>
        <input
          type="text"
          class="search-input"
          placeholder="Buscar por placa, modelo..."
          [(ngModel)]="searchQuery"
          (ngModelChange)="searchQuery.set($event); currentPage.set(1)"
        />
      </div>
      <div class="filters-row">
        <select
          class="filter-select"
          [(ngModel)]="vehicleTypeFilter"
          (ngModelChange)="vehicleTypeFilter.set($event); currentPage.set(1)"
        >
          <option value="">Tipo de Vehículo</option>
          <option value="truck">Camión</option>
          <option value="van">Van</option>
          <option value="motorcycle">Moto</option>
          <option value="tractor-trailer">Tractor-remolque</option>
        </select>
        <button class="filter-btn">
          <app-hero-icon name="funnel" [size]="18"></app-hero-icon>
          Filtrar
        </button>
      </div>
    </div>
  </div>

  <!-- Fleet Table Section -->
  <div class="table-card">
    <div class="table-header">
      <h2 class="table-title">Listado de Vehículos</h2>
      <span class="table-count">Mostrando {{ paginatedVehicles.length }} de {{ filteredVehicles.length }}</span>
    </div>

    @if (loading()) {
      <div class="table-loading">
        <div class="loading-spinner"></div>
        <p>Cargando vehículos...</p>
      </div>
    } @else if (error()) {
      <div class="table-error">
        <app-hero-icon name="exclamation-triangle" [size]="24"></app-hero-icon>
        <p>{{ error() }}</p>
      </div>
    } @else if (filteredVehicles.length === 0) {
      <div class="table-empty">
        <app-hero-icon name="truck" [size]="64" [strokeWidth]="1.5" class="empty-icon"></app-hero-icon>
        <p>No se encontraron vehículos</p>
      </div>
    } @else {
      <div class="table-wrapper">
        <table class="data-table">
          <thead>
            <tr>
              <th>Vehículo</th>
              <th>Tipo / Modelo</th>
              <th>Aliado</th>
              <th>Capacidad</th>
              <th>Estado</th>
              <th class="text-right">Acciones</th>
            </tr>
          </thead>
          <tbody>
            @for (vehicle of paginatedVehicles; track vehicle.id) {
              <tr class="table-row">
                <td>
                  <div class="vehicle-info">
                    <div class="vehicle-image" [style.background-image]="vehicle.image ? 'url(' + vehicle.image + ')' : 'none'">
                      @if (!vehicle.image) {
                        <app-hero-icon name="truck" [size]="24" class="vehicle-placeholder-icon"></app-hero-icon>
                      }
                    </div>
                    <div class="vehicle-details">
                      <p class="vehicle-plate">{{ vehicle.license_plate }}</p>
                      <p class="vehicle-id">ID: {{ vehicle.id }}</p>
                    </div>
                  </div>
                </td>
                <td>
                  <p class="vehicle-type">{{ getVehicleTypeLabel(vehicle.vehicle_type) }}</p>
                  <p class="vehicle-model">{{ vehicle.model || '-' }}</p>
                </td>
                <td>
                  <p class="vehicle-provider">{{ vehicle.provider_name || '-' }}</p>
                </td>
                <td>
                  <p class="vehicle-capacity">{{ vehicle.capacity || '-' }}</p>
                </td>
                <td>
                  <span class="status-badge" [class]="getStatusClass(vehicle.status)">
                    {{ getStatusLabel(vehicle.status) }}
                  </span>
                </td>
                <td class="text-right">
                  <div class="action-buttons">
                    <button class="action-btn" title="Ver Historial">
                      <app-hero-icon name="clock" [size]="18"></app-hero-icon>
                    </button>
                    <button class="action-btn" title="Editar">
                      <app-hero-icon name="pencil" [size]="18"></app-hero-icon>
                    </button>
                    <button class="action-btn action-btn-danger" title="Reportar Incidente">
                      <app-hero-icon name="exclamation-circle" [size]="18"></app-hero-icon>
                    </button>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination">
        <span class="pagination-info">
          Mostrando {{ startItem }} a {{ endItem }} de {{ filteredVehicles.length }} resultados
        </span>
        <div class="pagination-controls">
          <button
            class="pagination-btn"
            [disabled]="currentPage() === 1"
            (click)="previousPage()"
          >
            Anterior
          </button>
          @for (page of pages; track page) {
            <button
              class="pagination-btn"
              [class.pagination-btn-active]="currentPage() === page"
              (click)="goToPage(page)"
            >
              {{ page }}
            </button>
          }
          <button
            class="pagination-btn"
            [disabled]="currentPage() === totalPages"
            (click)="nextPage()"
          >
            Siguiente
          </button>
        </div>
      </div>
    }
  </div>
</div>

@if (createOpen()) {
  <div class="vehicle-modal-overlay">
    <div class="vehicle-modal">
      <div class="vehicle-modal-header">
        <div>
          <h2 class="vehicle-modal-title">Registro de Nuevo Vehículo</h2>
          <p class="vehicle-modal-subtitle">Complete los detalles técnicos y de propiedad de la unidad.</p>
        </div>
        <button class="vehicle-modal-close" (click)="closeCreateModal()" aria-label="Cerrar">
          <app-hero-icon name="x-mark" [size]="20"></app-hero-icon>
        </button>
      </div>
      <div class="vehicle-modal-body">
        <form [formGroup]="createForm" (ngSubmit)="submitCreateVehicle()" class="vehicle-modal-form">
          <section class="vehicle-modal-section">
            <div class="vehicle-modal-section-title">
              <app-hero-icon name="information-circle" [size]="18"></app-hero-icon>
              <h3>Información Básica</h3>
            </div>
            <div class="vehicle-form-grid vehicle-form-grid--three">
              <div class="vehicle-form-field">
                <label>Placa / Matrícula</label>
                <input formControlName="license_plate" placeholder="Ej: ABC-123" type="text" />
                @if (createForm.get('license_plate')?.touched && createForm.get('license_plate')?.invalid) {
                  <span class="vehicle-form-error">Ingresa una placa válida.</span>
                }
              </div>
              <div class="vehicle-form-field">
                <label>Marca</label>
                <input formControlName="brand" placeholder="Ej: Volvo" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Modelo</label>
                <input formControlName="model" placeholder="Ej: FH16" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Año</label>
                <input formControlName="year" type="number" />
              </div>
              <div class="vehicle-form-field span-2">
                <label>Tipo de Vehículo</label>
                <select formControlName="vehicle_type">
                  @for (type of vehicleTypes; track type.value) {
                    <option [value]="type.value">{{ type.label }}</option>
                  }
                </select>
              </div>
            </div>
          </section>

          <section class="vehicle-modal-section">
            <div class="vehicle-modal-section-title">
              <app-hero-icon name="wrench-screwdriver" [size]="18"></app-hero-icon>
              <h3>Especificaciones Técnicas</h3>
            </div>
            <div class="vehicle-form-grid vehicle-form-grid--three">
              <div class="vehicle-form-field">
                <label>Capacidad neta (kg)</label>
                <input formControlName="net_capacity_kg" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Volumen (m³)</label>
                <input formControlName="volume_m3" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Combustible</label>
                <input formControlName="fuel_type" placeholder="Ej: Diésel" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Peso tara (kg)</label>
                <input formControlName="tara_kg" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Peso bruto (kg)</label>
                <input formControlName="gross_weight_kg" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Color</label>
                <input formControlName="color" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Largo (m)</label>
                <input formControlName="length_m" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Ancho (m)</label>
                <input formControlName="width_m" type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Alto (m)</label>
                <input formControlName="height_m" type="text" />
              </div>
            </div>
          </section>

          <section class="vehicle-modal-section">
            <div class="vehicle-modal-section-title">
              <app-hero-icon name="user" [size]="18"></app-hero-icon>
              <h3>Asignación y Estado</h3>
            </div>
            <div class="vehicle-form-grid vehicle-form-grid--two">
              <div class="vehicle-form-field">
                <label>Aliado Propietario</label>
                <div class="vehicle-form-static">{{ allyLabel }}</div>
              </div>
              <div class="vehicle-form-field">
                <label>Estado</label>
                <select formControlName="status">
                  @for (status of statusOptions; track status.value) {
                    <option [value]="status.value">{{ status.label }}</option>
                  }
                </select>
              </div>
            </div>
          </section>

          <section class="vehicle-modal-section">
            <div class="vehicle-modal-section-title">
              <app-hero-icon name="folder" [size]="18"></app-hero-icon>
              <h3>Documentos y Foto</h3>
            </div>
            <div class="vehicle-form-grid vehicle-form-grid--two">
              <div class="vehicle-form-field">
                <label>Tarjeta de Propiedad (URL)</label>
                <input formControlName="owner_document" placeholder="https://..." type="text" />
              </div>
              <div class="vehicle-form-field">
                <label>Foto del Vehículo (URL)</label>
                <input formControlName="photo_url" placeholder="https://..." type="text" />
              </div>
            </div>
          </section>

          @if (createError()) {
            <div class="vehicle-form-alert">
              {{ createError() }}
            </div>
          }

          <div class="vehicle-modal-actions">
            <button type="button" class="vehicle-btn" (click)="closeCreateModal()">Cancelar</button>
            <button type="submit" [disabled]="createLoading()" class="vehicle-btn vehicle-btn-primary">
              @if (createLoading()) {
                Guardando...
              } @else {
                Guardar Vehículo
              }
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
}
