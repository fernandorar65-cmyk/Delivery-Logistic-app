<div class="vehicle-detail-page">
  <div class="breadcrumb">
    <a routerLink="/dashboard" class="breadcrumb-link">
      <app-hero-icon name="squares-2x2" [size]="16"></app-hero-icon>
      <span>Inicio</span>
    </a>
    <span class="breadcrumb-separator">/</span>
    <a routerLink="/allies" class="breadcrumb-link">Aliados</a>
    <span class="breadcrumb-separator">/</span>
    <a [routerLink]="['/allies', allyId(), 'vehicles']" class="breadcrumb-link">Vehículos</a>
    <span class="breadcrumb-separator">/</span>
    <span class="breadcrumb-current">Detalle</span>
  </div>

  @if (loading()) {
    <div class="vehicle-card vehicle-state">
      <div class="loading-spinner"></div>
      <p>Cargando vehículo...</p>
    </div>
  } @else if (error()) {
    <div class="vehicle-card vehicle-state error">
      <app-hero-icon name="exclamation-triangle" [size]="24"></app-hero-icon>
      <p>{{ error() }}</p>
    </div>
  } @else if (!vehicle()) {
    <div class="vehicle-card vehicle-state">
      <app-hero-icon name="truck" [size]="48"></app-hero-icon>
      <p>No se encontró el vehículo.</p>
    </div>
  } @else {
    <div class="vehicle-summary-card">
      <div class="vehicle-summary-media">
        <div
          class="vehicle-summary-image"
          [style.background-image]="vehicle()?.image ? 'url(' + vehicle()!.image + ')' : 'none'"
        >
          @if (!vehicle()?.image) {
            <app-hero-icon name="truck" [size]="28"></app-hero-icon>
          }
        </div>
        <span class="vehicle-status-pill" [class]="getStatusClass(vehicle()?.status)">
          {{ getStatusLabel(vehicle()?.status) }}
        </span>
      </div>
      <div class="vehicle-summary-content">
        <div class="vehicle-summary-header">
          <div>
            <h1>{{ vehicle()?.license_plate }}</h1>
            <p>{{ vehicle()?.brand || '-' }} {{ vehicle()?.model || '' }} • {{ vehicle()?.year || '-' }}</p>
          </div>
          <div class="vehicle-summary-actions">
            <button class="primary-btn" (click)="openEditModal()">
              <app-hero-icon name="pencil" [size]="18"></app-hero-icon>
              Editar Información
            </button>
            <button class="danger-btn" (click)="openDeleteModal()">
              <app-hero-icon name="exclamation-circle" [size]="18"></app-hero-icon>
              Dar de Baja
            </button>
          </div>
        </div>
        <div class="vehicle-summary-meta">
          <div class="meta-item">
            <span class="meta-label">Aliado</span>
            <span class="meta-value">{{ vehicle()?.provider_name || allyLabel }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Tipo</span>
            <span class="meta-value">{{ getVehicleTypeLabel(vehicle()?.vehicle_type) }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Capacidad</span>
            <span class="meta-value">{{ vehicle()?.capacity || (vehicle()?.net_capacity_kg ? vehicle()?.net_capacity_kg + ' kg' : '-') }}</span>
          </div>
          <div class="meta-item">
            <span class="meta-label">Carrocería</span>
            <span class="meta-value">{{ vehicle()?.body_type || '-' }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="vehicle-detail-grid">
      <section class="vehicle-card">
        <div class="card-header">
          <h3>Detalles Técnicos</h3>
          <app-hero-icon name="information-circle" [size]="18" class="muted-icon"></app-hero-icon>
        </div>
        <div class="card-grid">
          <div class="card-item">
            <span class="card-label">Marca / Modelo</span>
            <span class="card-value">{{ vehicle()?.brand || '-' }} {{ vehicle()?.model || '' }}</span>
          </div>
          <div class="card-item">
            <span class="card-label">Capacidad de Carga</span>
            <span class="card-value">{{ vehicle()?.net_capacity_kg || '-' }} kg</span>
          </div>
          <div class="card-item">
            <span class="card-label">Color</span>
            <span class="card-value">{{ vehicle()?.color || '-' }}</span>
          </div>
          <div class="card-item">
            <span class="card-label">Tipo de Carrocería</span>
            <span class="card-value">{{ vehicle()?.body_type || '-' }}</span>
          </div>
          <div class="card-item">
            <span class="card-label">Dimensiones</span>
            <span class="card-value">
              {{ vehicle()?.length_m || '-' }} x {{ vehicle()?.width_m || '-' }} x {{ vehicle()?.height_m || '-' }} m
            </span>
          </div>
          <div class="card-item">
            <span class="card-label">Peso bruto</span>
            <span class="card-value">{{ vehicle()?.gross_weight_kg || '-' }} kg</span>
          </div>
        </div>
      </section>

      <section class="vehicle-card">
        <div class="card-header">
          <h3>Documentación Vigente</h3>
          <button class="link-btn">Gestionar Todo</button>
        </div>
        <div class="card-list">
          <div class="doc-item">
            <div class="doc-icon">
              <app-hero-icon name="folder" [size]="18"></app-hero-icon>
            </div>
            <div>
              <p>SOAT - Seguro Obligatorio</p>
              <span>Póliza #{{ vehicle()?.id || '0000' }}</span>
            </div>
            <div class="doc-status ok">VIGENTE</div>
          </div>
          <div class="doc-item warning">
            <div class="doc-icon warn">
              <app-hero-icon name="exclamation-triangle" [size]="18"></app-hero-icon>
            </div>
            <div>
              <p>Revisión Técnico Mecánica</p>
              <span>Certificado #{{ vehicle()?.id || '0000' }}</span>
            </div>
            <div class="doc-status warn">POR VENCER</div>
          </div>
        </div>
      </section>

      <section class="vehicle-card metrics-card">
        <div class="card-header">
          <h3>Métricas de Rendimiento</h3>
        </div>
        <div class="metric-item">
          <div class="metric-row">
            <span>Consumo de Combustible</span>
            <strong>32.5 L/100km</strong>
          </div>
          <div class="metric-bar">
            <span class="metric-bar-fill" style="width: 65%;"></span>
          </div>
          <span class="metric-footnote">Promedio mensual: 31.2 L</span>
        </div>
        <div class="metric-highlight">
          <app-hero-icon name="map-pin" [size]="18"></app-hero-icon>
          <div>
            <p>Km Recorridos</p>
            <strong>12,450</strong>
            <span>Este mes</span>
          </div>
        </div>
        <div class="metric-highlight alert">
          <app-hero-icon name="exclamation-circle" [size]="18"></app-hero-icon>
          <div>
            <p>Incidentes Reportados</p>
            <strong>2</strong>
            <span>Total</span>
          </div>
        </div>
      </section>
    </div>
  }
</div>

@if (editOpen()) {
  <div class="vehicle-edit-overlay" (click)="closeEditModal()">
    <div class="vehicle-edit-modal" (click)="$event.stopPropagation()">
      <div class="vehicle-edit-header">
        <div>
          <h2>Editar Vehículo</h2>
          <p>Actualiza la información principal de la unidad.</p>
        </div>
        <button class="vehicle-edit-close" (click)="closeEditModal()" aria-label="Cerrar">
          <app-hero-icon name="x-mark" [size]="20"></app-hero-icon>
        </button>
      </div>
      <form [formGroup]="editForm" (ngSubmit)="submitEditVehicle()" class="vehicle-edit-body">
        <div class="vehicle-edit-grid vehicle-edit-grid--three">
          <div class="vehicle-edit-field">
            <label>Placa / Matrícula</label>
            <input formControlName="license_plate" type="text" placeholder="Ej: ABC-123" />
            @if (editForm.get('license_plate')?.touched && editForm.get('license_plate')?.invalid) {
              <span class="vehicle-edit-error">Ingresa una placa válida.</span>
            }
          </div>
          <div class="vehicle-edit-field">
            <label>Marca</label>
            <input formControlName="brand" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Modelo</label>
            <input formControlName="model" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Año</label>
            <input formControlName="year" type="number" />
          </div>
          <div class="vehicle-edit-field span-2">
            <label>Tipo de Vehículo</label>
            <select formControlName="vehicle_type">
              @for (type of vehicleTypes; track type.value) {
                <option [value]="type.value">{{ type.label }}</option>
              }
            </select>
          </div>
        </div>

        <div class="vehicle-edit-grid vehicle-edit-grid--three">
          <div class="vehicle-edit-field">
            <label>Color</label>
            <input formControlName="color" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Tipo de Carrocería</label>
            <input formControlName="body_type" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Capacidad neta (kg)</label>
            <input formControlName="net_capacity_kg" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Peso tara (kg)</label>
            <input formControlName="tara_kg" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Peso bruto (kg)</label>
            <input formControlName="gross_weight_kg" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Estado</label>
            <select formControlName="status">
              @for (status of statusOptions; track status.value) {
                <option [value]="status.value">{{ status.label }}</option>
              }
            </select>
          </div>
        </div>

        <div class="vehicle-edit-grid vehicle-edit-grid--three">
          <div class="vehicle-edit-field">
            <label>Largo (m)</label>
            <input formControlName="length_m" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Ancho (m)</label>
            <input formControlName="width_m" type="text" />
          </div>
          <div class="vehicle-edit-field">
            <label>Alto (m)</label>
            <input formControlName="height_m" type="text" />
          </div>
        </div>

        @if (editError()) {
          <div class="vehicle-edit-alert">{{ editError() }}</div>
        }

        <div class="vehicle-edit-actions">
          <button type="button" class="vehicle-edit-btn" (click)="closeEditModal()">Cancelar</button>
          <button type="submit" class="vehicle-edit-btn primary" [disabled]="editLoading()">
            @if (editLoading()) {
              Guardando...
            } @else {
              Guardar Cambios
            }
          </button>
        </div>
      </form>
    </div>
  </div>
}

@if (deleteOpen()) {
  <div class="vehicle-delete-overlay" (click)="closeDeleteModal()">
    <div class="vehicle-delete-modal" (click)="$event.stopPropagation()">
      <div class="vehicle-delete-icon">
        <app-hero-icon name="exclamation-triangle" [size]="24"></app-hero-icon>
      </div>
      <h2>Confirmar Baja de Vehículo</h2>
      <p>¿Estás seguro de que deseas dar de baja este vehículo?</p>
      <span class="vehicle-delete-warning">ESTA ACCIÓN ES IRREVERSIBLE.</span>

      @if (deleteError()) {
        <div class="vehicle-delete-error">{{ deleteError() }}</div>
      }

      <div class="vehicle-delete-actions">
        <button class="vehicle-delete-btn danger" (click)="confirmDelete()" [disabled]="deleteLoading()">
          @if (deleteLoading()) {
            Procesando...
          } @else {
            Confirmar Baja
          }
        </button>
        <button class="vehicle-delete-btn" (click)="closeDeleteModal()" type="button">
          Mantener Vehículo
        </button>
      </div>
    </div>
  </div>
}
