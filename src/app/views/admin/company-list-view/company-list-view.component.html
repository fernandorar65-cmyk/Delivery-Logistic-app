<div class="page-container">
  <div class="page-header">
    <div class="page-title-section">
      <h1 class="page-title">Administración de Compañías Clientes</h1>
      <p class="page-subtitle">Gestione sus clientes finales y sus entidades operativas.</p>
    </div>
    <button (click)="openNewCompanyModal()" class="btn btn-primary">
      <app-hero-icon name="plus" [size]="18"></app-hero-icon>
      Agregar Nueva Compañía
    </button>
  </div>

  @if (loading()) {
    <div class="card loading-card">
      <div class="loading-spinner"></div>
      <p>Cargando empresas...</p>
    </div>
  } @else if (error()) {
    <div class="card error-card">
      <app-hero-icon name="exclamation-triangle" [size]="24"></app-hero-icon>
      <p>{{ error() }}</p>
    </div>
  } @else {
    <app-companies-toolbar
      [searchQuery]="searchQuery()"
      [activeFilters]="activeFilters()"
      [sectors]="sectors()"
      [cities]="cities()"
      [selectedSector]="selectedSector()"
      [selectedCity]="selectedCity()"
      (searchChange)="searchQuery.set($event); applyFilters()"
      (removeFilter)="removeFilter($event)"
      (clearFilters)="clearAllFilters()"
      (sectorChange)="selectedSector.set($event); applyFilters()"
      (cityChange)="selectedCity.set($event); applyFilters()"
    ></app-companies-toolbar>

    @if (!filteredCompanies() || filteredCompanies().length === 0) {
      <div class="card empty-state-card">
        <app-hero-icon name="users" [size]="64" [strokeWidth]="1.5" class="empty-icon"></app-hero-icon>
        <h3>No se encontraron empresas</h3>
        <p>Intenta ajustar los filtros de búsqueda</p>
      </div>
    } @else {
      <app-companies-table
        [companies]="paginatedCompanies"
        [getCompanyColor]="getCompanyColor.bind(this)"
        [getCompanyInitials]="getCompanyInitials.bind(this)"
        [getSectorClass]="getSectorClass.bind(this)"
        [getStatusClass]="getStatusClass.bind(this)"
        [getStatusLabel]="getStatusLabel.bind(this)"
        (edit)="openEditCompanyModal($event)"
        (remove)="deleteCompany($event)"
      ></app-companies-table>

      <app-companies-pagination
        [startItem]="startItem"
        [endItem]="endItem"
        [totalItems]="filteredCompanies().length"
        [currentPage]="currentPage()"
        [totalPages]="totalPages"
        [pages]="getPageNumbers()"
        (previous)="previousPage()"
        (next)="nextPage()"
        (goTo)="goToPage($event)"
      ></app-companies-pagination>
    }
  }

  <!-- Modal Flotante -->
  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">{{ isEditMode() ? 'Editar Empresa' : 'Nueva Empresa' }}</h2>
          <button class="modal-close" (click)="closeModal()" type="button">
            <app-hero-icon name="x-mark" [size]="24"></app-hero-icon>
          </button>
        </div>

        <form [formGroup]="companyForm" (ngSubmit)="onSubmit()" class="modal-form">
          @if (formError()) {
            <div class="form-error-message">
              <app-hero-icon name="exclamation-circle" [size]="20"></app-hero-icon>
              <span>{{ formError() }}</span>
            </div>
          }

          <div class="form-section">
            <h3 class="section-title">Información Básica</h3>
            
            <div class="form-group">
              <label for="company_name">
                Nombre de Empresa <span class="required">*</span>
              </label>
              <input
                type="text"
                id="company_name"
                formControlName="company_name"
                placeholder="Ingrese el nombre de la empresa"
                [class.invalid]="companyForm.get('company_name')?.invalid && companyForm.get('company_name')?.touched"
              />
              @if (companyForm.get('company_name')?.invalid && companyForm.get('company_name')?.touched) {
                <span class="error-text">{{ getFieldError('company_name') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="ruc">
                RUC <span class="required">*</span>
              </label>
              <input
                type="text"
                id="ruc"
                formControlName="ruc"
                placeholder="Ingrese el RUC"
                [class.invalid]="companyForm.get('ruc')?.invalid && companyForm.get('ruc')?.touched"
              />
              @if (companyForm.get('ruc')?.invalid && companyForm.get('ruc')?.touched) {
                <span class="error-text">{{ getFieldError('ruc') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="email">
                Email <span class="required">*</span>
              </label>
              <input
                type="email"
                id="email"
                formControlName="email"
                placeholder="correo@ejemplo.com"
                [class.invalid]="companyForm.get('email')?.invalid && companyForm.get('email')?.touched"
              />
              @if (companyForm.get('email')?.invalid && companyForm.get('email')?.touched) {
                <span class="error-text">{{ getFieldError('email') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="description">
                Descripción
              </label>
              <textarea
                id="description"
                formControlName="description"
                placeholder="Ingrese una descripción de la empresa"
                rows="3"
              ></textarea>
            </div>

            <div class="form-group">
              <label for="password">
                Contraseña 
                @if (!isEditMode()) {
                  <span class="required">*</span>
                } @else {
                  <span class="optional">(opcional - dejar en blanco para no cambiar)</span>
                }
              </label>
              <input
                type="password"
                id="password"
                formControlName="password"
                [placeholder]="isEditMode() ? 'Dejar en blanco para no cambiar' : 'Ingrese la contraseña'"
                [class.invalid]="companyForm.get('password')?.invalid && companyForm.get('password')?.touched"
              />
              @if (companyForm.get('password')?.invalid && companyForm.get('password')?.touched) {
                <span class="error-text">{{ getFieldError('password') }}</span>
              }
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="formLoading()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="companyForm.invalid || formLoading()">
              {{ isEditMode() ? 'Guardar Cambios' : 'Crear Empresa' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
