<div class="page-container">
  <div class="page-header">
    <div class="page-title-section">
      <h1 class="page-title">Administración de Compañías Clientes</h1>
      <p class="page-subtitle">Gestione sus clientes finales y sus entidades operativas.</p>
    </div>
    <button (click)="openNewCompanyModal()" class="btn btn-primary">
      <app-hero-icon name="plus" [size]="18"></app-hero-icon>
      Agregar Nueva Compañía
    </button>
  </div>

  @if (loading()) {
    <div class="card loading-card">
      <div class="loading-spinner"></div>
      <p>Cargando empresas...</p>
    </div>
  } @else if (error()) {
    <div class="card error-card">
      <app-hero-icon name="exclamation-triangle" [size]="24"></app-hero-icon>
      <p>{{ error() }}</p>
    </div>
  } @else {
    <!-- Search and Filters Bar -->
    <div class="search-filters-bar">
      <div class="search-container">
        <app-hero-icon name="magnifying-glass" [size]="20" class="search-icon"></app-hero-icon>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Buscar por nombre de empresa o NIT..."
          [value]="searchQuery()"
          (input)="onSearchChange($event)"
        />
      </div>

      @if (activeFilters().length > 0) {
        <div class="active-filters">
          @for (filter of activeFilters(); track filter.type) {
            <span class="filter-tag">
              @if (filter.type === 'status') {
                Estado: {{ filter.value }}
              } @else if (filter.type === 'sector') {
                Sector: {{ filter.value }}
              } @else if (filter.type === 'city') {
                Ciudad: {{ filter.value }}
              }
              <button type="button" class="filter-remove" (click)="removeFilter(filter.type)">
                <app-hero-icon name="x-mark" [size]="14"></app-hero-icon>
              </button>
            </span>
          }
          <button type="button" class="clear-filters-btn" (click)="clearAllFilters()">
            Limpiar filtros
          </button>
        </div>
      }

      <div class="filter-dropdowns">
        <select class="filter-select" [value]="selectedSector()" (change)="onSectorChange($event)">
          <option value="all">Sector: Todos</option>
          @for (sector of sectors(); track sector) {
            <option [value]="sector">Sector: {{ sector }}</option>
          }
        </select>
        <select class="filter-select" [value]="selectedCity()" (change)="onCityChange($event)">
          <option value="all">Ciudad: Todas</option>
          @for (city of cities(); track city) {
            <option [value]="city">Ciudad: {{ city }}</option>
          }
        </select>
      </div>
    </div>

    @if (!filteredCompanies() || filteredCompanies().length === 0) {
      <div class="card empty-state-card">
        <app-hero-icon name="users" [size]="64" [strokeWidth]="1.5" class="empty-icon"></app-hero-icon>
        <h3>No se encontraron empresas</h3>
        <p>Intenta ajustar los filtros de búsqueda</p>
      </div>
    } @else {
      <div class="card table-card">
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>LOGO & NOMBRE</th>
                <th>NIT/ID FISCAL</th>
                <th>SECTOR</th>
                <th>CIUDAD</th>
                <th>SEDES</th>
                <th>ESTADO</th>
                <th class="actions-header">ACCIONES</th>
              </tr>
            </thead>
            <tbody>
              @for (company of paginatedCompanies; track company.id) {
                <tr>
                  <td class="logo-name-cell">
                    <div class="company-logo-name">
                      <div class="company-logo" [style.background-color]="getCompanyColor(company.company_name)">
                        {{ getCompanyInitials(company.company_name) }}
                      </div>
                      <div class="company-info">
                        <strong class="company-name">{{ company.company_name }}</strong>
                        <span class="company-subtitle">{{ company.description || 'Sin descripción' }}</span>
                      </div>
                    </div>
                  </td>
                  <td class="nit-cell">{{ company.ruc }}</td>
                  <td>
                    <span class="sector-badge" [class]="getSectorClass(company.sector)">
                      {{ company.sector || '-' }}
                    </span>
                  </td>
                  <td>{{ company.city || '-' }}</td>
                  <td class="branches-cell">{{ company.branches || 0 }}</td>
                  <td>
                    <div class="status-indicator">
                      <span class="status-dot" [class]="getStatusClass(company.status)"></span>
                      <span>{{ getStatusLabel(company.status) }}</span>
                    </div>
                  </td>
                  <td class="actions-cell">
                    <div class="action-buttons">
                      <button (click)="openEditCompanyModal(company)" class="action-btn edit-btn" title="Editar">
                        <app-hero-icon name="pencil" [size]="16"></app-hero-icon>
                      </button>
                      <button (click)="deleteCompany(company.id!)" class="action-btn delete-btn" title="Eliminar">
                        <app-hero-icon name="trash" [size]="16"></app-hero-icon>
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Paginación -->
        <div class="pagination">
          <div class="pagination-info">
            Mostrando {{ startItem }}-{{ endItem }} de {{ filteredCompanies().length }} compañía{{ filteredCompanies().length !== 1 ? 's' : '' }}
          </div>
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              [disabled]="currentPage() === 1"
              (click)="previousPage()"
            >
              Anterior
            </button>
            <div class="pagination-numbers">
              @for (page of getPageNumbers(); track $index) {
                @if (page === '...') {
                  <span class="pagination-ellipsis">...</span>
                } @else {
                  <button 
                    class="pagination-number"
                    [class.active]="currentPage() === page"
                    (click)="goToPageFromTemplate(page)"
                  >
                    {{ page }}
                  </button>
                }
              }
            </div>
            <button 
              class="pagination-btn" 
              [disabled]="currentPage() === totalPages"
              (click)="nextPage()"
            >
              Siguiente
            </button>
          </div>
        </div>
      </div>
    }
  }

  <!-- Modal Flotante -->
  @if (showModal()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2 class="modal-title">{{ isEditMode() ? 'Editar Empresa' : 'Nueva Empresa' }}</h2>
          <button class="modal-close" (click)="closeModal()" type="button">
            <app-hero-icon name="x-mark" [size]="24"></app-hero-icon>
          </button>
        </div>

        <form [formGroup]="companyForm" (ngSubmit)="onSubmit()" class="modal-form">
          @if (formError()) {
            <div class="form-error-message">
              <app-hero-icon name="exclamation-circle" [size]="20"></app-hero-icon>
              <span>{{ formError() }}</span>
            </div>
          }

          <div class="form-section">
            <h3 class="section-title">Información Básica</h3>
            
            <div class="form-group">
              <label for="company_name">
                Nombre de Empresa <span class="required">*</span>
              </label>
              <input
                type="text"
                id="company_name"
                formControlName="company_name"
                placeholder="Ingrese el nombre de la empresa"
                [class.invalid]="companyForm.get('company_name')?.invalid && companyForm.get('company_name')?.touched"
              />
              @if (companyForm.get('company_name')?.invalid && companyForm.get('company_name')?.touched) {
                <span class="error-text">{{ getFieldError('company_name') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="ruc">
                RUC <span class="required">*</span>
              </label>
              <input
                type="text"
                id="ruc"
                formControlName="ruc"
                placeholder="Ingrese el RUC"
                [class.invalid]="companyForm.get('ruc')?.invalid && companyForm.get('ruc')?.touched"
              />
              @if (companyForm.get('ruc')?.invalid && companyForm.get('ruc')?.touched) {
                <span class="error-text">{{ getFieldError('ruc') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="email">
                Email <span class="required">*</span>
              </label>
              <input
                type="email"
                id="email"
                formControlName="email"
                placeholder="correo@ejemplo.com"
                [class.invalid]="companyForm.get('email')?.invalid && companyForm.get('email')?.touched"
              />
              @if (companyForm.get('email')?.invalid && companyForm.get('email')?.touched) {
                <span class="error-text">{{ getFieldError('email') }}</span>
              }
            </div>

            <div class="form-group">
              <label for="description">
                Descripción
              </label>
              <textarea
                id="description"
                formControlName="description"
                placeholder="Ingrese una descripción de la empresa"
                rows="3"
              ></textarea>
            </div>

            <div class="form-group">
              <label for="password">
                Contraseña 
                @if (!isEditMode()) {
                  <span class="required">*</span>
                } @else {
                  <span class="optional">(opcional - dejar en blanco para no cambiar)</span>
                }
              </label>
              <input
                type="password"
                id="password"
                formControlName="password"
                [placeholder]="isEditMode() ? 'Dejar en blanco para no cambiar' : 'Ingrese la contraseña'"
                [class.invalid]="companyForm.get('password')?.invalid && companyForm.get('password')?.touched"
              />
              @if (companyForm.get('password')?.invalid && companyForm.get('password')?.touched) {
                <span class="error-text">{{ getFieldError('password') }}</span>
              }
            </div>
          </div>

          <div class="modal-actions">
            <button type="button" class="btn btn-secondary" (click)="closeModal()" [disabled]="formLoading()">
              Cancelar
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="companyForm.invalid || formLoading()">
              {{ isEditMode() ? 'Guardar Cambios' : 'Crear Empresa' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }
</div>
